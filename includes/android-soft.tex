
\chapter{DroidWatcher}
\label{chap:droidwatcher}


% \begin{itemize}
% \item But du logiciel
% \item Manuel d'utilisation
% \item Fonctionnement technique
%   \begin{itemize}
%   \item Méthodes utilisées
%   \item Triangulation antennes GSM home-made
%   \item Activation GPS via bug
%   \end{itemize}

% \item Problèmes de développement
%   \begin{itemize}
%   \item Développé principalement sur un modèle de smartphone en particulier
%   \item Limitation accès Android 4
%   \item Android met en veille des process arbitrairement
%   \end{itemize}
% \end{itemize}

\section{The aim behind DroidWatcher}

In Chapter \ref{chap:and-loc}, it has been explained how the localization works in the Android devices.
What are the methods and how work the localization using wireless.
In Chapter \ref{chap:and-secu}, it has been explained how an application could behave through the Android system.
What is the control of the user, what are the limits of the permission system and how malwares abuse from the user confidence.\\

DroidWatcher is an application that request several permissions including the one to access the user location.
Using this permission the application can record the user permission at all time and monitor its movements.
The application can be also controled via text messaging invisibly and sends the recorded location over the internet to a remote server.
The application purpose is not to create a malware tracing devices but making the users realising what a device is capable of and how important it is to estimate the risk of malicious behaviour before installing an application.
Also having having this application installed could be useful in case of loss or theft of the device.\\

\section{Location features}

\subsection{GPS activation}

The GPS of a device can be remotely activated (see SMS commands at section \label{sec:dw-smscom}).
This feature is possible due to a bug discovered in the power control widget\footnote{Issue 7890 \url{https://code.google.com/p/android/issues/detail?id=7890}}.
Even if the security flaw has been revealed in April 2010 and a patch released in April 2011, the flaw has been observed as still exploitable on most Android devices running Android 2.3.
\emph{TODO: tester sur un Android 4.0}

\subsection{Cell triangulation}
The implemented triangulation mechanism using GSM cell towers is inefficient if the device is not connected to the internet.
To resolve this constraint, the DroidWatcher application monitors the surroung cell towers identification information and will use this information to compute the location in the futur, the next time the device is connected to internet.\\

An unofficial API to the Google GSM cell tower database has been discovered and is used to retrieve the location of each cell tower.
This database has been selected as it is one of the most complete compared to the other free alternatives.\\

\emph{schema du méchanisme utilisé}

This triangulation mechanism is however known as unprecise as explained in Section \ref{sec:dw-difficult-cell} about technical difficulties.

\section{Technical difficulties}

To develop this application, several constrains were met that limited the effect of the application.

\subsection{Automatic idle}

Once going in idle state (once the device is not used by the user for a certain amount of time), the operating system will limit the possibility of the system to save battery.
Some applications will be paused in there running process.
The effectiveness of the localization process done by DroidWatcher is affected by this idle purpose.\\

This is the case for example of the GPS that needs to constant update of the position.
The GPS will sometime stop monitoring the postion of the user if it can not get a fix\footnote{cf Section \ref{sec:loc-gps} for the information needed to get a GPS fix} on the location of the user.
This effect is undependant of the application but the direct consequence of the system behaviour for battery saving. 
This issue is often a complain related to the tracking application (eg: sport monitoring application).
A solution is avoid the phone to going to idle state by keeping it in awake state.
This solution as however not been used in DroidWatcher as it would have greatly compromised the battery usage of the phone and consequently the effectiveness of the application in monitoring the location the logest and more discrete way as possible.

\subsection{Android 4.0}
\label{sec:dw-ics}

As the author of this thesis owns only a device with the Android version 2.3.
At the time of development, end 2011, the fourth version\footnote{The third version of the operating system was limited to tablet devices and not phones limiting greatly the propagation of this version of the system.} of Android was just released and very few devices were capable of running it.
Consequently the testing has been done mainly on devices running the second version of the operating system.\\

And unexpected change introduced in the 4.0 version of Android was the way a device manage the start of an application in background.
DroidWatcher has been concieved to be started when a device is booting or waked from idle.
This feature participated in the aim to be fully discrete and that the application was not noticable without analysis.
In Android 4.0, an application can no longer start during the boot or after having been woken up if the interface has not been launched a first time.\\

To fix this problem, an interface screen has been developed.
This screen allows the user to see location information and basic configuration.\\

This change is certainly an improvement in the security of a device as the need for a graphical interface will strongly reduce the possibility of malicious \emph{invisible} application to run.
However malicious applications often use a fake interface (weather forecast, game...) to hide the malicious behaviour of the software and this protection will therefore not affect these applications.

\subsection{Cell tower triangulation}
\label{sec:dw-difficult-cell}

To compute the location of the user, a triangulation algorithm has been developed.
This algorithm is however known as unprecise for several reason.
To compute the location, the algorithm uses the signal strength captured GSM cell towers nearby.
The signal strength is a very fluctuating variable.
At a same distance to an cell tower, the signal will variate if the device is inside or outside a building or if monitored by two different devices with different GSM receiver.
The main imprecision comes from the fact that all cell tower do not emit signal at the same signal strength (rural areas are usually covered with less cell towers emitting using higher signal strengths.\\

As efficient computation of the signal strength would have requiered long monitoring, the compuation and ponderation of the variables has been done based on personal observation.
This is known as unprecise but achieve the purpose to be able to record an approximate location at all time when GSM connectivity is available.\\

\section{User manual}

\subsection{Interface}
\label{sec:dw-gui}

For configuration ease and to solve the restriction appearing on Android 4.0 as explained in Section \ref{sec:dw-ics}, a configuration interface has been created.
This interface allows to see the last location computed and the date of the last synchronisation to the remote server.
The option are also given to specify a specific data collection URL and choose if the phone will or not reply to SMS commands.

\subsection{SMS commands}
\label{sec:dw-smscom}


The messages are intercepted before arriving to the message application. If the message contains a defined code, the phone will do a defined action in consequence.

\begin{itemize}
\item The messages are not case sensitive.
\item The match should be exact (no extra character).
\item The application does not record the content of messages, the messages not containing the code will not be affected.
\end{itemize}

\vspace{0.5cm}
\texttt{BIGBRO} : starting code for a command.
\begin{itemize}
\item \texttt{LOCME} : reply with the last recorded location
\item \texttt{GPSON} : turn the GPS on
\item \texttt{WIFION} : turn the wireless on
\item \texttt{SETSERVER[new\_server\_url]} : set
  the url of the server, default
  \url{http://watcher.dotzero.me/collect}
%\item SETTHRESHOLD[new\_threshold] : set the collect threshold, in millisecond, below 60,000 is not adviced
\end{itemize}

\vspace{0.5cm}
Examples of correct messages:
\begin{itemize}
\item BIGBGPSON
\item bigbSetServerhttp://watcher.dotzer.me/collect
\item Ping
\end{itemize}

\vspace{0.5cm}
Examples of incorrect messages
\begin{itemize}
\item BIGB GPSON
\item Ping!
\end{itemize}
\vspace{0.5cm}
To easily test if the app is running send the message \texttt{PING}, the target cell phone replies with message containing \texttt{PONG}.\\
Turning on the GPS is done by exploiting a bug in some Android roms. It was reported as working on v2 Android ROM and CyonengMod 7.

\section{What collects the application ?}

\begin{itemize}
\item Estimated location and time of the recording
\item Google username
\item IMSI (International Mobile Subscriber Identity)
\item Phone number (if written in the SIM card, usually not)
\end{itemize}

The Google username is collected to easily differentiate the users while the IMSI and phone number are to ensure the uniqueness.
Note that the IMSI and phone number do not requiere any permission and that any application can collect it.

\section{What collects the application ?}

\begin{itemize}
\item Estimated location and time of the recording
\item Google username
\item IMSI (International Mobile Subscriber Identity)
\item Phone number (if written in the SIM card, usually not)
\end{itemize}

The Google username is collected to easily differentiate the users while the IMSI and phone number are to ensure the uniqueness.
Note that the IMSI and phone number do not requiere any permission and that any application can collect it.

\section{When run the application ?}

The application start at the phone boots and when the user unlock its phone. Killing the process will only stop it until the next time the phone is unlocked. Uninstalling the application \texttt{DroidWatcher} will fully remove it.

\section{What is stored on my phone ?}

The last collected cell towers and last locations are collected in the file \texttt{.log.obj} at the root of the SD card. You can remove this file safely.

\section{Who can see my location ?}

To ensure privacy, only the owner of the server is able to see the collected location.

\section{Install application on its own server}

To see the information collected, you can install the DroidWatcher collecting website on your own web server.
The server use the python framework Django 1.3\footnote{Available at \url{https://www.djangoproject.com/}}.
The following steps explain the deployement of the application on a Debian Lenny server running Apache and mod-wsgi. The full configuration and securitization of the apache server is considered as out of the scoop of these explanations.

\begin{enumerate}
\item Download the latest version of Django\\
  \texttt{\$ wget http://www.djangoproject.com/download/1.3.1/tarball/ -O django.tar.gz}
\item Extract and install\\
  \texttt{\$ tar -xzvf django.tar.gz\\\$ cd Django-1.3.1\\\$ sudo python setup.py install}
\item Extract and deploy the DroidWatcher Django application from the DroidWatcher package\\
  \texttt{\$ tar -xzvf watcher.tar.gz\\\$ sudo mv watcher /var/www/watcher}
\item Change the ownership to the apache user\\
  \texttt{\$ sudo chown -R www-data:www-data /var/www/watcher}
\item Update the apache configuration file (probably \texttt{/etc/apache2/sites-enabled/000-default}) and add
\begin{verbatim}
<VirtualHost *:80>
             ServerName SERVERURL
             Alias /static/ /var/www/watcher/static/
             <Directory /var/www/watcher/static>
             Order deny,allow
             Allow from all
             </Directory>
             WSGIScriptAlias / /var/www/watcher/apache/django.wsgi
</VirtualHost>
\end{verbatim}
\item Update eventually the django setting in \texttt{watcher/settings.py} files if you want to configure your email or have changed the location of the application folder.
\item Generate the database. In the application folder, execute\\
  \texttt{\$ python manage.py syncdb}\\
  and choose an admin password.
\item Restart the apache module\\
  \texttt{\$ sudo service apache2 restart}
\item Access the received location by going to \url{http://SERVERURL/admin} to log in and them access to the recorded location at \url{http://SERVERURL/}
\end{enumerate}
