
\chapter{DroidWatcher}
\label{chap:droidwatcher}

Droidwatcher aims at demonstrating the concrete accessibility of localisation services.
In the context of this thesis the application takes only acceptable actions.
But of course more invasive actions could be taken by malicious developers.

\begin{figure}[h]
  \centering
  \includegraphics[width=9cm]{images/dw-archi.png}
  \caption{DroidWatcher system architecture}
  \label{fig:dw-archi}
\end{figure}

DroidWatcher is made of two major components as represented in Figure \ref{fig:dw-archi}: 

\begin{itemize}
\item A mobile application running on a smartphone\\
  The application essentially collects location data on a regular basis.
\item A server-based application\\
  The application centralizes the data pushed the smartphones as soon as those smartphones have an internet access.
\end{itemize}

This chapter presents more specifically the mobile application.
Installation guide and user manual on the complete DroidWatcher solution can be found in appendix \ref{dw-guide}
% \section{Presentation}

% % In Chapter \ref{chap:and-loc}, it has been explained how the localization works in the Android devices.
% % What are the methods and how work the localization using wireless.
% % In Chapter \ref{chap:and-secu}, it has been explained how an application could behave through the Android system.
% % What is the control of the user, what are the limits of the permission system and how malwares abuse from the user confidence.\\

% DroidWatcher is an application that requests several permissions including the one to access the user location.
% Using this permission, the application can record the user permission at all time and monitor its movements.
% The application can be also controlled via text messaging invisibly and sends the recorded location over the internet to a remote server.
% The application purpose is not to create a malware tracing devices but making the users realising what a device is capable of and how important it is to estimate the risk of malicious behaviour before installing an application.
% Also having having this application installed could be useful in case of loss or theft of the device.\\

% Appendix \ref{sec:dw-user-manual} contains the user manual and Appendix \ref{sec:dw-django} describe how to install the remote server application.

\subsection{Monitoring}

Every specified time interval (15min by default), DroidWatcher records the location of the device.
Depending on what is available, it can use the GPS, wireless or GSM cell location capabilities, keeping the most accurate one.
The locations received are stored in a file on the SD card.
Once the device is connected to internet, it will sync to a remote server to upload the last recorded coordinates.\\

All these operations are done automatically and does not require any user interaction.
The application keeps recording locations when the user does not use its smartphone.
The application starts at phone boot or when unlocked (exception with Android 4.0 or above, see Section \ref{sec:dw-ics}).

\section{Cell tower triangulation}

When a device needs to record the current location but is not capable to access the Internet, the program records the surrounding cell towers information.
The described triangulation algorithm is applied once the coordinates of the collected cell towers are retrieved, the next time the smartphone is connect to the Internet.

\subsection{Scenarios}

To triangulate a device using the cell towers, the following scenarios have been considered:

\begin{enumerate}
\item One GSM tower is within range
\item Two GSM towers are within range
\item More than two GSM towers are within range
\end{enumerate}

The case where no GSM tower is within range is not considered as the location can not be estimated and the algorithm is not used.
To evaluate the location, a \emph{centre point} is decided and a \emph{confidence range} is computed.
The device is estimated to be located within the area covered by the circle drawn using the centre point and the confidence as radius.\\

It has been decided not to differentiate the eventuality of more than three different cell towers as it will greatly increase the complexity of the algorithm without increasing the accuracy of the method proportionally, as intended by the limitations explained in Section \ref{sec:dw-difficult-cell}.

\subsection{Determine the position}

Depending of theses three scenarios, the according centres will be decided as:

\begin{enumerate}
\item The location of the only GSM tower within range
\item Along the median between the two GSM towers
\item \emph{The intersection between the two closest towers that is on the side of the third closest tower} Reformuler
\end{enumerate}

If more than three GSM towers are within range, the closest towers are determined as the ones with the strongest signal strength.\\

\begin{figure}[h]
  \centering
  \includegraphics[width=8cm]{images/tower-schema.png}
  \caption{Triangulation scenario with 3 GSM towers}
  \label{fig:triangulation-scenario-3}
\end{figure}
The third scenario is illustrated in Figure \ref{fig:triangulation-scenario-3}.
The tower A and B are considered as the closest to the device as received with the highest signal strength, the tower C is the third closest to the phone.
For each tower, a circle of a radius size related to the signal strength is drawn.
Two points D and E are computed as the intersection between the circles of centre A and B.
The point D is determined as the best centre point as it is the one closest to the tower C and is then evaluated as the location of the device.\\

In the three considered cases, the confidence range is determined as
\begin{enumerate}
\item The conversion of the signal strength to meters
\item The distance between the two intersections
\item The half of the distance between the two intersections
\end{enumerate}

\emph{Comment justifier l'utilisation de la distance ?}

\subsection{Signal strength conversion}

If a device receive a GSM signal at a determined strength, it is possible to estimate its distance from the cell tower.
A circle is drawn around the GSM tower representing every position the device could be.
The strongest the signal is, the closest is the device to the tower.\\

The signal strength collected by the Android device is expressed in \emph{ASU}, for Arbitrary Strength Unit, which is a value between 0 and 31 derived from the signal strength usually computed in decibel\footnote{For the GSM network, $dBm = 2 × ASU - 113$}.
0 ASU representing the lowest signal and 31 the strongest.
The way to express the conversion is made using the following formula :\\

\[
 (-\sqrt{asu}+6)*900
\]

The weighting of the factors has been decided based on personal observations using the author's smartphone.

\section{Location features}

\subsection{GPS activation}

The GPS of a device can be remotely activated (see SMS commands Section \ref{sec:dw-smscom}).
This feature is possible due to a bug discovered in the power control widget\footnote{Issue 7890 \url{https://code.google.com/p/android/issues/detail?id=7890}}.
Even if the security flaw has been revealed in April 2010 and a patch released in April 2011, the flaw has been observed as still exploitable on most Android devices running Android 2.3.

%\emph{TODO: tester sur un Android 4.0}

\subsection{Cell triangulation}
The native triangulation mechanism using GSM cell towers is inefficient if the device is not connected to the Internet at the time of the location request.
To resolve this constraint, the DroidWatcher application monitors the surrounding cell towers identification information and will use this information to compute the location in the future, the next time the device is connected to internet.\\

An unofficial API to the Google GSM cell tower database has been discovered and is used to retrieve the location of each cell tower.
This database has been selected as it is one of the most complete compared to the other free alternatives.\\

%\emph{schema du méchanisme utilisé}

This triangulation mechanism is however known as imprecise as explained in Section \ref{sec:dw-difficult-cell} about technical difficulties.

\section{Technical difficulties}

To develop this application, several constrains were met that limited the effect of the application.

\subsection{Automatic idle}

Once going in idle state (once the device is not used by the user for a certain amount of time), the operating system will limit the possibility of the system to save battery.
Some applications will be paused in there running process.
The effectiveness of the localisation process done by DroidWatcher is affected by this idle purpose.\\

This is the case, for example, of the GPS that needs to constantly update of the position.
The GPS will sometime stop monitoring the position of the user if it can not get a fix\footnote{See Section \ref{sec:loc-gps} for the information needed to get a GPS fix} on the location of the user.
This effect is independent of the application but the direct consequence of the system behaviour for battery saving. 
This issue is often a complain related to the tracking application (eg: sport monitoring application).
A solution is avoid the phone to going to idle state by keeping it in awake state.
However, this solution is not used in DroidWatcher as it would have greatly compromised the battery usage of the phone and consequently the effectiveness of the application in monitoring the location the longest and most discrete way as possible.

\subsection{Android 4.0}
\label{sec:dw-ics}

As the author of this thesis owns only a device with the Android version 2.3.
At the time of development, end 2011, the fourth version\footnote{The third version of the operating system was limited to tablet devices and not phones limiting greatly the propagation of this version of the system.} of Android was just released and very few devices were capable of running it.
Consequently the testing has been done mainly on devices running the second version of the operating system.\\

An unexpected change introduced in the 4.0 version\footnote{The change was already present since the version 3.1 for tablets but reflected to smartphones only since the version 4.0} of Android is the way a device manage the start of an application in background.
DroidWatcher has been conceived to be started when a device is booting or waked from idle.
This feature participated in the aim to be fully discrete and that the application was not noticeable without analysis.
With Android 4.0, an application can no longer start during the boot or after having been woken up if the interface has not been launched a first time~\cite{boot-restrictions}.\\

To fix this problem, an interface screen has been developed.
This screen allows the user to see location information and basic configuration.\\

This change is certainly an improvement in the security of a device as the need for a graphical interface will strongly reduce the possibility of malicious \emph{invisible} application to run.
However malicious applications often use a fake interface (weather forecast, game...) to hide the malicious behaviour of the software and this protection will therefore not affect these applications.

\subsection{Cell tower triangulation}
\label{sec:dw-difficult-cell}

To compute the location of the user, a triangulation algorithm has been developed.
This algorithm is however known as imprecise for several reason.
To compute the location, the algorithm uses the signal strength of captured GSM cell towers nearby.
The signal strength is a very fluctuating variable.
At a same distance to a cell tower, the signal varies if the device is inside or outside a building or if monitored by two different devices with different GSM receiver.
The main imprecision comes from the fact that all cell tower do not emit signal at the same signal strength (rural areas are usually covered with less cell towers emitting using higher signal strengths.\\

As efficient computation of the signal strength would have required long monitoring and observation on a large number of devices and areas.
The computation and weighting of the variables has been done based on personal observations.
This is known as imprecise but achieves the purpose to be able to record a reasonable approximation of the location at any time when GSM connectivity is available.\\


\section{FAQ}
\label{sec:faq}

\subsection{What data is collected by the application ?}

\begin{itemize}
\item Estimated location and time of the recording
\item Google username
\item IMSI (International Mobile Subscriber Identity)
\item Phone number (if written in the SIM card, usually not)
\end{itemize}

The Google username is collected to easily differentiate the users while the IMSI and phone number are to ensure the uniqueness.
Note that the IMSI and phone number do not require any permission and that any application can collect it.

\subsection{What is collected by the application ?}

\begin{itemize}
\item Estimated location and time of the recording
\item Google username
\item IMSI (International Mobile Subscriber Identity)
\item Phone number\footnote{Only if written in the SIM card, depends on the phone provider.}
\end{itemize}

The Google username is collected to easily differentiate the users while the IMSI and phone number are to ensure the uniqueness.
Note that the IMSI and phone number do not require any permission and that any application can collect it.

\subsection{When run the application ?}

The application start at the phone boots and when the user unlock its phone.
Except if using Android 4.0 or above, killing the process will only stop it until the next time the phone is unlocked.
Uninstalling the application \texttt{DroidWatcher} will fully remove it.

\subsection{What is stored on the phone ?}

The last collected cell towers and last locations are collected in the file \texttt{.log.obj} at the root of the SD card. You can remove this file safely.

\subsection{Who is able to see the recorded location ?}

To ensure privacy, only the owner of the server is able to see the collected location.
